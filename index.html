<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Five-a-Side Finance Tracker</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
        }
        .modal {
            display: none; /* Hidden by default */
            position: fixed; /* Stay in place */
            z-index: 100; /* Sit on top */
            left: 0;
            top: 0;
            width: 100%; /* Full width */
            height: 100%; /* Full height */
            overflow: auto; /* Enable scroll if needed */
            background-color: rgba(0,0,0,0.4); /* Black w/ opacity */
            padding-top: 60px;
        }
        .modal-content {
            background-color: #fefefe;
            margin: 5% auto;
            padding: 20px;
            border: 1px solid #888;
            width: 80%;
            max-width: 500px;
            border-radius: 0.5rem;
        }
        .close {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
        }
        .close:hover,
        .close:focus {
            color: black;
            text-decoration: none;
            cursor: pointer;
        }
        .loader {
            border: 5px solid #f3f3f3;
            border-radius: 50%;
            border-top: 5px solid #3498db;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        #loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.8);
            z-index: 9999;
            display: flex;
            justify-content: center;
            align-items: center;
            flex-direction: column;
            gap: 1rem;
        }
        /* Style for the login container */
        #auth-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            z-index: 10000;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        #auth-card {
            background: white;
            padding: 2rem;
            border-radius: 0.5rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            width: 90%;
            max-width: 400px;
        }
        .hidden {
            display: none !important;
        }
        .opacity-50 {
            opacity: 0.5;
        }
        .pointer-events-none {
            pointer-events: none;
        }
    </style>
</head>
<body class="p-4 md:p-8">

    <div id="loading-overlay">
        <div class="loader"></div>
        <p class="text-gray-600">Loading data...</p>
    </div>

    <div id="auth-container" class="hidden">
        <div id="auth-card">
            <h2 class="text-2xl font-bold text-gray-800 mb-4">Admin Login</h2>
            <p class="text-gray-600 mb-4">Log in to enable editing features.</p>
            <div class="space-y-4">
                <div>
                    <label for="admin-email" class="block text-sm font-medium text-gray-700">Email</label>
                    <input type="email" id="admin-email" class="mt-1 block w-full p-2 border border-gray-300 rounded-md">
                </div>
                <div>
                    <label for="admin-password" class="block text-sm font-medium text-gray-700">Password</label>
                    <input type="password" id="admin-password" class="mt-1 block w-full p-2 border border-gray-300 rounded-md">
                </div>
                <button id="admin-login-btn" class="w-full bg-indigo-600 text-white px-4 py-2 rounded-md hover:bg-indigo-700">Login</button>
                <p id="auth-error-message" class="text-red-500 text-sm mt-2"></p>
                <button id="close-login-modal-btn" class="w-full bg-gray-300 text-gray-800 px-4 py-2 rounded-md hover:bg-gray-400 mt-2">Close</button>
            </div>
        </div>
    </div>


    <div class="max-w-7xl mx-auto">
        <header class="mb-8">
            <h1 class="text-3xl font-bold text-gray-800">Five-a-Side Finance Tracker</h1>
            <p class="text-gray-600 mt-1">Manage your team's game fees and payments effortlessly.</p>
            <p class="text-xs text-gray-500 mt-2">Data Source ID: <span id="userId" class="font-mono bg-gray-200 px-1 rounded"></span> (Status: <span id="auth-status" class="font-bold"></span>)</p>
            <div class="mt-2 text-right">
                <button id="open-login-modal-btn" class="text-sm text-blue-600 hover:text-blue-800">Admin Login</button>
                <button id="logout-btn" class="text-sm text-red-600 hover:text-red-800 hidden ml-2">Log Out</button>
            </div>
        </header>

        <div class="mb-6">
            <label for="season-selector" class="block text-sm font-medium text-gray-700">Select Season</label>
            <select id="season-selector" class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm rounded-md">
                </select>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
            <div class="lg:col-span-2 space-y-8">
                <section>
                    <h2 class="text-2xl font-semibold text-gray-700 mb-4">Financial Summary</h2>
                    <div class="bg-white p-6 rounded-lg shadow-md">
                        <div class="overflow-x-auto">
                            <table class="min-w-full divide-y divide-gray-200">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Player</th>
                                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Total Owed (All Seasons)</th>
                                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Total Paid (All Seasons)</th>
                                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Overall Balance</th>
                                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider editable-actions-th">Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="summary-table-body" class="bg-white divide-y divide-gray-200">
                                    </tbody>
                            </table>
                        </div>
                    </div>
                </section>

                 <section>
                    <h2 class="text-2xl font-semibold text-gray-700 mb-4">Players</h2>
                     <div class="bg-white p-6 rounded-lg shadow-md">
                        <div id="player-list" class="flex flex-wrap gap-3 mb-4">
                            </div>
                        <div class="flex gap-2 editable-actions">
                             <input type="text" id="new-player-name" placeholder="Enter new player name" class="flex-grow p-2 border border-gray-300 rounded-md focus:ring-indigo-500 focus:border-indigo-500">
                             <button id="add-player-btn" class="bg-indigo-600 text-white px-4 py-2 rounded-md hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">Add Player</button>
                        </div>
                     </div>
                </section>
            </div>

            <div class="lg:col-span-1 space-y-6">
                 <h2 class="text-2xl font-semibold text-gray-700">Game Weeks (<span id="current-season-name"></span>)</h2>
                 <button id="add-gameweek-btn" class="w-full bg-green-600 text-white px-4 py-3 rounded-md hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500 shadow-md editable-actions">
                    + Add New Game Week
                </button>
                <div id="gameweeks-container" class="space-y-4 mt-4">
                    </div>
            </div>
        </div>

        <section class="mt-8">
            <h2 class="text-2xl font-semibold text-gray-700 mb-4">Player Payment & Game Status</h2>
            <div class="bg-white p-6 rounded-lg shadow-md">
                <div class="mb-4 flex items-center gap-4">
                    <label for="filter-player-select" class="block text-sm font-medium text-gray-700">Select Player:</label>
                    <select id="filter-player-select" class="mt-1 block pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm rounded-md flex-grow">
                        <option value="">All Players</option>
                        </select>
                </div>
                <div id="player-status-details" class="space-y-4">
                    <p class="text-gray-500 text-center">Select a player to see their payment and game details.</p>
                </div>
            </div>
        </section>
    </div>

    <div id="gameweek-modal" class="modal">
        <div class="modal-content">
            <span class="close" id="modal-close-btn">&times;</span>
            <h3 id="modal-title" class="text-xl font-semibold mb-4">Add New Game Week</h3>
            <div class="space-y-4">
                <div>
                    <label for="gameweek-date" class="block text-sm font-medium text-gray-700">Game Date</label>
                    <input type="date" id="gameweek-date" class="mt-1 block w-full p-2 border border-gray-300 rounded-md">
                </div>
                <div>
                    <label for="gameweek-cost" class="block text-sm font-medium text-gray-700">Total Cost (£)</label>
                    <input type="number" id="gameweek-cost" placeholder="e.g., 39.00" step="0.01" class="mt-1 block w-full p-2 border border-gray-300 rounded-md">
                </div>
                <div>
                    <h4 class="text-sm font-medium text-gray-700 mb-2">Who Played?</h4>
                    <div id="modal-player-list" class="space-y-2 max-h-60 overflow-y-auto border p-2 rounded">
                        </div>
                </div>
                <div>
                    <h4 class="text-sm font-medium text-gray-700 mb-2">Players Paid For By Others:</h4>
                    <div id="paid-for-by-others-section" class="space-y-2 max-h-40 overflow-y-auto border p-2 rounded">
                        </div>
                </div>
                <button id="save-gameweek-btn" class="w-full bg-indigo-600 text-white px-4 py-2 rounded-md hover:bg-indigo-700">Save Game Week</button>
            </div>
        </div>
    </div>

    <div id="add-payment-modal" class="modal">
        <div class="modal-content">
            <span class="close" id="payment-modal-close-btn">&times;</span>
            <h3 class="text-xl font-semibold mb-4">Add Payment for <span id="payment-player-name" class="text-indigo-600"></span></h3>
            <div class="space-y-4">
                <div>
                    <label for="payment-date" class="block text-sm font-medium text-gray-700">Payment Date</label>
                    <input type="date" id="payment-date" class="mt-1 block w-full p-2 border border-gray-300 rounded-md">
                </div>
                <div>
                    <label for="payment-amount" class="block text-sm font-medium text-gray-700">Amount (£)</label>
                    <input type="number" id="payment-amount" placeholder="e.g., 10.00" step="0.01" class="mt-1 block w-full p-2 border border-gray-300 rounded-md">
                </div>
                <button id="save-payment-btn" class="w-full bg-green-600 text-white px-4 py-2 rounded-md hover:bg-green-700">Add Payment</button>
            </div>
        </div>
    </div>


    <script type="module">
        // Firebase Imports
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, doc, addDoc, getDocs, onSnapshot, setDoc, deleteDoc, query, writeBatch, updateDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- CONFIG & INITIALIZATION ---
        const firebaseConfig = {
            apiKey: "AIzaSyD66s7x0dvADRqvIEUE1iB1XWzQpIDFKec",
            authDomain: "footballtracking-728b2.firebaseapp.com",
            projectId: "footballtracking-728b2",
            storageBucket: "footballtracking-728b2.firebasestorage.app",
            messagingSenderId: "658190902452",
            appId: "1:658190902452:web:9527e2dd19fcf4569ca3e1",
            measurementId: "G-1F3SVRJ7NN"
        };
        
        const appId = 'default-football-tracker';

        // IMPORTANT: This is the UID where ALL your data will be stored.
        const DATA_OWNER_UID = "VbrZ2srWbkQRYn0yM0L5nyruiMc2"; 
        // IMPORTANT: This is the UID of the user who can log in as admin and edit.
        const ADMIN_LOGIN_UID = "Q7JRa29G7PhrAMIECH7VcGHcKIn1"; 
        
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);

        // --- STATE ---
        let currentUserId = DATA_OWNER_UID; 
        let currentAuthUser = null; 
        let isAdminLoggedIn = false;

        let currentSeasonId = null;
        let editingGameWeekId = null;
        let selectedPlayerForPayment = null; 
        let players = [];
        let seasons = [];
        let allGameWeeks = []; 
        let allPayments = []; 
        let unsubscribes = []; 
        let currentSeasonGameWeeks = []; 

        // --- DOM ELEMENTS ---
        const loadingOverlay = document.getElementById('loading-overlay');
        const authContainer = document.getElementById('auth-container');
        const adminEmailInput = document.getElementById('admin-email');
        const adminPasswordInput = document.getElementById('admin-password');
        const adminLoginBtn = document.getElementById('admin-login-btn');
        const authErrorMessage = document.getElementById('auth-error-message');
        const closeLoginModalBtn = document.getElementById('close-login-modal-btn');

        const userIdSpan = document.getElementById('userId');
        const authStatusSpan = document.getElementById('auth-status');
        const openLoginModalBtn = document.getElementById('open-login-modal-btn');
        const logoutBtn = document.getElementById('logout-btn'); 

        const addPlayerBtn = document.getElementById('add-player-btn');
        const newPlayerNameInput = document.getElementById('new-player-name');
        const playerListContainer = document.getElementById('player-list');
        const summaryTableBody = document.getElementById('summary-table-body');
        const addGameWeekBtn = document.getElementById('add-gameweek-btn');
        const gameWeekModal = document.getElementById('gameweek-modal');
        const modalCloseBtn = document.getElementById('modal-close-btn');
        const modalTitle = document.getElementById('modal-title');
        const saveGameWeekBtn = document.getElementById('save-gameweek-btn');
        const modalPlayerList = document.getElementById('modal-player-list');
        const paidForByOthersSection = document.getElementById('paid-for-by-others-section'); 
        const gameWeeksContainer = document.getElementById('gameweeks-container');
        const seasonSelector = document.getElementById('season-selector');
        const currentSeasonNameSpan = document.getElementById('current-season-name'); 

        const addPaymentModal = document.getElementById('add-payment-modal');
        const paymentModalCloseBtn = document.getElementById('payment-modal-close-btn');
        const paymentPlayerNameSpan = document.getElementById('payment-player-name');
        const paymentDateInput = document.getElementById('payment-date');
        const paymentAmountInput = document.getElementById('payment-amount');
        const savePaymentBtn = document.getElementById('save-payment-btn');

        const filterPlayerSelect = document.getElementById('filter-player-select');
        const playerStatusDetails = document.getElementById('player-status-details');

        const editableElements = document.querySelectorAll('.editable-actions'); 
        const editableActionsTh = document.querySelector('.editable-actions-th'); 


        // --- AUTHENTICATION & UI CONTROL ---
        onAuthStateChanged(auth, async (user) => {
            currentAuthUser = user; 

            userIdSpan.textContent = DATA_OWNER_UID;
            loadingOverlay.style.display = 'flex';

            if (user && user.uid === ADMIN_LOGIN_UID) {
                isAdminLoggedIn = true;
                authStatusSpan.textContent = "Admin (Logged In)";
                authStatusSpan.classList.remove('text-red-600');
                authStatusSpan.classList.add('text-green-600');
                logoutBtn.classList.remove('hidden');
                openLoginModalBtn.classList.add('hidden');
                authContainer.classList.add('hidden');
                enableEditingFeatures();
            } else {
                isAdminLoggedIn = false;
                authStatusSpan.textContent = "Viewer (Read Only)";
                authStatusSpan.classList.remove('text-green-600');
                authStatusSpan.classList.add('text-red-600');
                logoutBtn.classList.add('hidden');
                openLoginModalBtn.classList.remove('hidden');
                authContainer.classList.add('hidden');
                disableEditingFeatures();
            }
            await initializeAppData(); 
            loadingOverlay.style.display = 'none';
        });

        adminLoginBtn.addEventListener('click', async () => {
            const email = adminEmailInput.value;
            const password = adminPasswordInput.value;
            authErrorMessage.textContent = ''; 

            if (!email || !password) {
                authErrorMessage.textContent = "Please enter email and password.";
                return;
            }

            loadingOverlay.style.display = 'flex';
            try {
                await signInWithEmailAndPassword(auth, email, password);
                adminEmailInput.value = '';
                adminPasswordInput.value = '';
            } catch (error) {
                console.error("Login failed:", error.code, error.message);
                authErrorMessage.textContent = `Login failed: ${error.message}`;
                loadingOverlay.style.display = 'none'; 
            }
        });

        openLoginModalBtn.addEventListener('click', () => {
            authErrorMessage.textContent = '';
            authContainer.classList.remove('hidden');
        });

        closeLoginModalBtn.addEventListener('click', () => {
            authContainer.classList.add('hidden');
        });

        logoutBtn.addEventListener('click', async () => {
            try {
                await signOut(auth);
                console.log("Logged out successfully.");
            } catch (error) {
                console.error("Logout failed:", error);
            }
        });

        function enableEditingFeatures() {
            document.querySelectorAll('.editable-actions').forEach(el => el.classList.remove('hidden', 'opacity-50', 'pointer-events-none'));
            if (editableActionsTh) editableActionsTh.classList.remove('hidden'); 
            renderPlayers(); // Re-render to show delete buttons
            renderGameWeeks(); // Re-render to show edit/delete buttons
            calculateAndRenderAll(); // Re-render to show actions column
        }

        function disableEditingFeatures() {
            document.querySelectorAll('.editable-actions').forEach(el => el.classList.add('hidden', 'opacity-50', 'pointer-events-none'));
            if (editableActionsTh) editableActionsTh.classList.add('hidden'); 
            renderPlayers(); // Re-render to hide delete buttons
            renderGameWeeks(); // Re-render to hide edit/delete buttons
            calculateAndRenderAll(); // Re-render to hide actions column
        }

        // --- DATA INITIALIZATION & LISTENERS ---
        async function initializeAppData() {
            const basePath = `artifacts/${appId}/users/${currentUserId}`;
            
            const playersRef = collection(db, `${basePath}/players`);
            onSnapshot(playersRef, (snapshot) => {
                players = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderPlayers();
                renderFilterPlayerSelect();
                calculateAndRenderAll(); 
                renderPlayerStatusDetails(filterPlayerSelect.value); 
            });

            const seasonsRef = collection(db, `${basePath}/seasons`);
            onSnapshot(seasonsRef, async (snapshot) => {
                if (snapshot.empty && isAdminLoggedIn) { 
                    await seedInitialData();
                } else if (!snapshot.empty) {
                    seasons = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })).sort((a,b) => a.startDate.localeCompare(b.startDate));
                    renderSeasonSelector();
                    if (!currentSeasonId || !seasons.find(s => s.id === currentSeasonId)) {
                        currentSeasonId = seasons[seasons.length - 1]?.id; 
                    }
                    seasonSelector.value = currentSeasonId;
                    updateCurrentSeasonDisplay(); 
                    await fetchAllSeasonData(); 
                } else {
                    loadingOverlay.style.display = 'none';
                    summaryTableBody.innerHTML = `<tr><td colspan="5" class="text-center py-4 text-gray-500">No data available. Admin must log in to set up.</td></tr>`;
                    gameWeeksContainer.innerHTML = '';
                }
            });
        }
        
        async function fetchAllSeasonData() {
            unsubscribes.forEach(unsub => unsub());
            unsubscribes = [];

            allGameWeeks = [];
            allPayments = [];

            const basePath = `artifacts/${appId}/users/${currentUserId}`;

            for (const season of seasons) {
                const gameWeeksRef = collection(db, `${basePath}/seasons/${season.id}/gameWeeks`);
                const unsubGw = onSnapshot(gameWeeksRef, (snapshot) => {
                    const newGameWeeks = snapshot.docs.map(doc => ({ id: doc.id, seasonId: season.id, ...doc.data() }));
                    
                    allGameWeeks = allGameWeeks.filter(gw => gw.seasonId !== season.id);
                    allGameWeeks = allGameWeeks.concat(newGameWeeks);
                    
                    currentSeasonGameWeeks = allGameWeeks.filter(gw => gw.seasonId === currentSeasonId);

                    renderGameWeeks(); 
                    calculateAndRenderAll(); 
                    renderPlayerStatusDetails(filterPlayerSelect.value); 
                    checkAndCreateAutoGameWeek();
                    loadingOverlay.style.display = 'none';
                });
                unsubscribes.push(unsubGw);
            }

            const paymentsRef = collection(db, `${basePath}/payments`); 
            const unsubPayments = onSnapshot(paymentsRef, (snapshot) => {
                allPayments = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                calculateAndRenderAll(); 
                renderPlayerStatusDetails(filterPlayerSelect.value); 
                loadingOverlay.style.display = 'none'; 
            });
            unsubscribes.push(unsubPayments);
        }

        // --- RENDERING FUNCTIONS ---
        function updateCurrentSeasonDisplay() {
            const selectedSeason = seasons.find(s => s.id === currentSeasonId);
            currentSeasonNameSpan.textContent = selectedSeason ? selectedSeason.name : 'No Season Selected';
        }

        function renderSeasonSelector() {
            seasonSelector.innerHTML = '';
            seasons.forEach(season => {
                const option = document.createElement('option');
                option.value = season.id;
                option.textContent = season.name;
                seasonSelector.appendChild(option);
            });
        }

        function renderPlayers() {
            playerListContainer.innerHTML = '';
            players.sort((a, b) => a.name.localeCompare(b.name)).forEach(player => {
                const playerTag = document.createElement('div');
                playerTag.className = 'bg-gray-200 text-gray-800 text-sm font-medium px-3 py-1 rounded-full flex items-center gap-2';
                const deleteButtonHtml = isAdminLoggedIn ? `<button data-player-id="${player.id}" class="delete-player-btn text-red-500 hover:text-red-700 font-bold">&times;</button>` : '';
                playerTag.innerHTML = `<span>${player.name}</span>${deleteButtonHtml}`;
                playerListContainer.appendChild(playerTag);
            });
            document.querySelectorAll('.delete-player-btn').forEach(btn => {
                btn.addEventListener('click', (e) => deletePlayer(e.currentTarget.dataset.playerId));
            });
        }

        function renderGameWeeks() {
            gameWeeksContainer.innerHTML = '';
            
            const numberedGameWeeks = currentSeasonGameWeeks
                .sort((a, b) => new Date(a.date) - new Date(b.date))
                .map((gw, index) => ({ ...gw, gameWeekNumber: index + 1 }))
                .sort((a, b) => new Date(b.date) - new Date(a.date));


            numberedGameWeeks.forEach(gw => {
                const cost = parseFloat(gw.totalCost || 0);
                const allPlayersInvolved = (gw.playerIds || []).map(id => {
                    const playerFound = players.find(p => p.id === id);
                    if (!playerFound) return null;
                    const paidForBy = gw.paidForBy && gw.paidForBy[id] ? gw.paidForBy[id] : null;
                    if (paidForBy && paidForBy !== id) {
                        const payerName = players.find(p => p.id === paidForBy)?.name;
                        return { id, name: `${playerFound.name} (paid by ${payerName || 'Unknown'})` };
                    }
                    return { id, name: playerFound.name };
                }).filter(Boolean);
                
                const numPlayers = gw.playerIds?.length || 0;
                const costPerPlayer = numPlayers > 0 ? (cost / numPlayers) : 0;

                const card = document.createElement('div');
                card.className = 'bg-white p-4 rounded-lg shadow-sm border';
                const actionsHtml = isAdminLoggedIn ? `
                    <div class="flex flex-col items-end gap-2">
                         <button data-gameweek-id="${gw.id}" class="edit-gameweek-btn text-blue-500 hover:text-blue-700 text-xs font-semibold">Edit</button>
                         <button data-gameweek-id="${gw.id}" class="delete-gameweek-btn text-red-400 hover:text-red-600 text-xs">&times; Delete</button>
                    </div>` : '';

                card.innerHTML = `
                    <div class="flex justify-between items-start">
                        <div>
                            <p class="font-bold text-gray-800">Game Week ${gw.gameWeekNumber}: ${new Date(gw.date).toLocaleDateString('en-GB', { day: '2-digit', month: 'short', year: 'numeric' })}</p>
                            <p class="text-sm text-gray-600">Total: £${cost.toFixed(2)}</p>
                            <p class="text-xs text-gray-500">${numPlayers} players (£${costPerPlayer.toFixed(2)} each)</p>
                        </div>
                        ${actionsHtml}
                    </div>
                    <div class="mt-2 text-xs text-gray-500">
                        ${allPlayersInvolved.map(p => p.name).join(', ') || 'No players selected'}
                    </div>`;
                gameWeeksContainer.appendChild(card);
            });

            document.querySelectorAll('.delete-gameweek-btn').forEach(btn => {
                btn.addEventListener('click', (e) => deleteGameWeek(e.currentTarget.dataset.gameweekId));
            });
            document.querySelectorAll('.edit-gameweek-btn').forEach(btn => {
                btn.addEventListener('click', (e) => openGameWeekModal(e.currentTarget.dataset.gameweekId));
            });
        }

        function calculateAndRenderAll() {
            if (!players.length) { 
                summaryTableBody.innerHTML = `<tr><td colspan="5" class="text-center py-4 text-gray-500">Add players to begin.</td></tr>`;
                return;
            }

            const playerBalances = calculatePlayerBalances();
            
            summaryTableBody.innerHTML = '';
            playerBalances.sort((a,b) => a.name.localeCompare(b.name)).forEach(data => {
                const row = document.createElement('tr');
                const balanceClass = data.balance < -0.01 ? 'text-red-600 font-semibold' : (data.balance > 0.01 ? 'text-green-600 font-semibold' : 'text-gray-700');
                
                let actionsHtml = `<td class="px-6 py-4"></td>`; 
                if (isAdminLoggedIn) {
                    actionsHtml = `
                        <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                            <button data-player-id="${data.id}" class="open-payment-modal-btn text-indigo-600 hover:text-indigo-900">Add Payment</button>
                        </td>`;
                }

                row.innerHTML = `
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${data.name}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">£${data.totalOwed.toFixed(2)}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">£${data.totalPaid.toFixed(2)}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm ${balanceClass}">£${data.balance.toFixed(2)}</td>
                    ${actionsHtml}`;
                summaryTableBody.appendChild(row);
            });

            document.querySelectorAll('.open-payment-modal-btn').forEach(btn => {
                btn.addEventListener('click', (e) => openAddPaymentModal(e.currentTarget.dataset.playerId));
            });
        }

        function calculatePlayerBalances() {
            const playerBalances = players.map(player => ({
                id: player.id,
                name: player.name,
                totalOwed: 0,
                totalPaid: 0,
                balance: 0
            }));

            allGameWeeks.forEach(gw => {
                const cost = parseFloat(gw.totalCost || 0);
                const numPlayers = gw.playerIds?.length || 0;
                if (numPlayers > 0) {
                    const individualCost = cost / numPlayers;
                    gw.playerIds.forEach(playerId => {
                        const paidForByPlayerId = gw.paidForBy && gw.paidForBy[playerId] ? gw.paidForBy[playerId] : playerId;
                        const payerBalance = playerBalances.find(p => p.id === paidForByPlayerId);
                        if (payerBalance) {
                            payerBalance.totalOwed += individualCost;
                        }
                    });
                }
            });

            allPayments.forEach(payment => {
                const playerBalance = playerBalances.find(p => p.id === payment.playerId);
                if (playerBalance) {
                    playerBalance.totalPaid += parseFloat(payment.amount);
                }
            });

            playerBalances.forEach(player => {
                player.balance = player.totalPaid - player.totalOwed;
            });

            return playerBalances;
        }

        function renderFilterPlayerSelect() {
            filterPlayerSelect.innerHTML = '<option value="">All Players</option>';
            players.sort((a,b) => a.name.localeCompare(b.name)).forEach(player => {
                const option = document.createElement('option');
                option.value = player.id;
                option.textContent = player.name;
                filterPlayerSelect.appendChild(option);
            });
            filterPlayerSelect.value = filterPlayerSelect.value; 
        }

        function renderPlayerStatusDetails(selectedPlayerId) {
            playerStatusDetails.innerHTML = ''; 

            if (!selectedPlayerId) {
                playerStatusDetails.innerHTML = '<p class="text-gray-500 text-center">Select a player to see their payment and game details.</p>';
                return;
            }

            const player = players.find(p => p.id === selectedPlayerId);
            if (!player) return;

            const playerOwedGamesList = []; 
            
            allGameWeeks.sort((a,b) => new Date(a.date) - new Date(b.date)).forEach(gw => {
                const totalCost = parseFloat(gw.totalCost || 0);
                const numPlayers = gw.playerIds?.length || 0;
                const individualCost = numPlayers > 0 ? (totalCost / numPlayers) : 0;
                
                (gw.playerIds || []).forEach(playedPlayerId => {
                    const payerOfThisGame = gw.paidForBy && gw.paidForBy[playedPlayerId] ? gw.paidForBy[playedPlayerId] : playedPlayerId;
                    
                    if (payerOfThisGame === selectedPlayerId) {
                        playerOwedGamesList.push({
                            id: gw.id,
                            date: gw.date,
                            cost: individualCost,
                            paid: false, 
                            paidForPlayerName: playedPlayerId !== selectedPlayerId ? players.find(p => p.id === playedPlayerId)?.name : null 
                        });
                    }
                });
            });

            const playerPayments = allPayments
                .filter(p => p.playerId === selectedPlayerId)
                .sort((a, b) => new Date(a.date) - new Date(b.date));

            let currentPaymentIndex = 0;
            let currentPaymentRemaining = 0;

            playerOwedGamesList.forEach(game => {
                let gameCostRemaining = game.cost;

                while (gameCostRemaining > 0.01 && currentPaymentIndex < playerPayments.length) { 
                    const currentPayment = playerPayments[currentPaymentIndex];

                    if (currentPaymentRemaining <= 0.01) {
                         currentPaymentRemaining = parseFloat(currentPayment.amount);
                    }
                    
                    if (currentPaymentRemaining >= gameCostRemaining - 0.01) { 
                        currentPaymentRemaining -= gameCostRemaining;
                        gameCostRemaining = 0; 
                    } else { 
                        gameCostRemaining -= currentPaymentRemaining;
                        currentPaymentRemaining = 0; 
                        currentPaymentIndex++; 
                    }
                }
                
                game.paid = gameCostRemaining < 0.01; 
            });

            let paymentsHtml = `
                <h3 class="text-lg font-semibold mt-4 mb-2">Payment History for ${player.name}:</h3>
                <div class="bg-gray-50 p-3 rounded-md max-h-48 overflow-y-auto">
                    ${playerPayments.length > 0 ? `
                        <ul class="list-disc pl-5 text-sm text-gray-700">
                            ${playerPayments.map(p => `<li>£${parseFloat(p.amount).toFixed(2)} on ${new Date(p.date).toLocaleDateString('en-GB', {day: '2-digit', month: 'short', year: 'numeric'})}</li>`).join('')}
                        </ul>` : `<p class="text-gray-500">No payments recorded.</p>`
                    }
                </div>
            `;

            let gameStatusHtml = `
                <h3 class="text-lg font-semibold mt-4 mb-2">Game Status for ${player.name}:</h3>
                <div class="bg-gray-50 p-3 rounded-md max-h-60 overflow-y-auto">
                    ${playerOwedGamesList.length > 0 ? `
                        <ul class="list-disc pl-5 text-sm text-gray-700">
                            ${playerOwedGamesList.map(game => {
                                const statusClass = game.paid ? 'text-green-600' : 'text-red-600';
                                const statusText = game.paid ? 'PAID' : 'UNPAID';
                                const paidForText = game.paidForPlayerName ? ` (for ${game.paidForPlayerName})` : '';
                                return `<li>Game on ${new Date(game.date).toLocaleDateString('en-GB', {day: '2-digit', month: 'short', year: 'numeric'})} (£${game.cost.toFixed(2)}): <span class="${statusClass}">${statusText}</span>${paidForText}</li>`;
                            }).join('')}
                        </ul>` : `<p class="text-gray-500">No games recorded for this player.</p>`
                    }
                </div>
            `;

            playerStatusDetails.innerHTML = paymentsHtml + gameStatusHtml;
        }


        // --- EVENT HANDLERS & FIRESTORE LOGIC ---
        seasonSelector.addEventListener('change', (e) => {
            currentSeasonId = e.target.value;
            updateCurrentSeasonDisplay();
            currentSeasonGameWeeks = allGameWeeks.filter(gw => gw.seasonId === currentSeasonId);
            renderGameWeeks(); 
            renderPlayerStatusDetails(filterPlayerSelect.value); 
        });

        filterPlayerSelect.addEventListener('change', (e) => {
            renderPlayerStatusDetails(e.target.value);
        });

        addPlayerBtn.addEventListener('click', async () => {
            if (!isAdminLoggedIn) { console.error("Admin privileges required."); return; }
            const name = newPlayerNameInput.value.trim();
            if (name) {
                const basePath = `artifacts/${appId}/users/${currentUserId}`; 
                await addDoc(collection(db, `${basePath}/players`), { name });
                newPlayerNameInput.value = '';
            }
        });
        
        async function deletePlayer(playerId) {
            if (!isAdminLoggedIn) { console.error("Admin privileges required."); return; }
            console.log("Deletion confirmation needed for player.");
            const basePath = `artifacts/${appId}/users/${currentUserId}`; 
            const batch = writeBatch(db);

            const playerDocRef = doc(db, `${basePath}/players`, playerId);
            batch.delete(playerDocRef);

            for (const season of seasons) {
                const seasonGameWeeksRef = collection(db, `${basePath}/seasons/${season.id}/gameWeeks`);
                const gameWeeksSnapshot = await getDocs(seasonGameWeeksRef);
                gameWeeksSnapshot.forEach(gwDoc => {
                    const gwData = gwDoc.data();
                    let updated = false;
                    const updatedPlayerIds = (gwData.playerIds || []).filter(id => {
                        if (id === playerId) {
                            updated = true;
                            return false;
                        }
                        return true;
                    });
                    
                    const updatedPaidForBy = { ...gwData.paidForBy };
                    if (updatedPaidForBy[playerId]) { 
                        delete updatedPaidForBy[playerId];
                        updated = true;
                    }
                    for (const pId in updatedPaidForBy) { 
                        if (updatedPaidForBy[pId] === playerId) {
                            delete updatedPaidForBy[pId]; 
                            updated = true;
                        }
                    }

                    if (updated) {
                        batch.update(gwDoc.ref, { playerIds: updatedPlayerIds, paidForBy: updatedPaidForBy });
                    }
                });
            }

            const userPaymentsRef = collection(db, `${basePath}/payments`);
            const paymentsSnapshot = await getDocs(userPaymentsRef);
            paymentsSnapshot.forEach(paymentDoc => {
                if (paymentDoc.data().playerId === playerId) {
                    batch.delete(paymentDoc.ref);
                }
            });

            await batch.commit();
            console.log("Player and associated data deleted.");
        }
        
        async function deleteGameWeek(gameWeekId) {
            if (!isAdminLoggedIn) { console.error("Admin privileges required."); return; }
            console.log("Deletion confirmation needed for game week.");
            const basePath = `artifacts/${appId}/users/${currentUserId}/seasons/${currentSeasonId}`; 
            await deleteDoc(doc(db, `${basePath}/gameWeeks`, gameWeekId));
        }

        // --- GAME WEEK MODAL LOGIC ---
        function openGameWeekModal(gameWeekId = null) {
            if (!isAdminLoggedIn) { console.error("Admin privileges required."); return; }
            editingGameWeekId = gameWeekId;
            modalPlayerList.innerHTML = '';
            paidForByOthersSection.innerHTML = ''; 
            
            let dateValue = new Date().toISOString().split('T')[0];
            let costValue = '39.00';
            let existingPlayerIds = [];
            let existingPaidForBy = {}; 

            if (editingGameWeekId) {
                const gw = currentSeasonGameWeeks.find(g => g.id === editingGameWeekId);
                modalTitle.textContent = 'Edit Game Week';
                saveGameWeekBtn.textContent = 'Update Game Week';
                dateValue = gw.date;
                costValue = gw.totalCost.toFixed(2);
                existingPlayerIds = gw.playerIds || [];
                existingPaidForBy = gw.paidForBy || {};
            } else {
                modalTitle.textContent = 'Add New Game Week';
                saveGameWeekBtn.textContent = 'Save Game Week';
            }

            document.getElementById('gameweek-date').value = dateValue;
            document.getElementById('gameweek-cost').value = costValue;

            players.sort((a, b) => a.name.localeCompare(b.name)).forEach(player => {
                const isChecked = existingPlayerIds.includes(player.id) ? 'checked' : '';
                const checkboxDiv = document.createElement('div');
                checkboxDiv.className = 'flex items-center';
                checkboxDiv.innerHTML = `<input id="gw-player-${player.id}" type="checkbox" value="${player.id}" ${isChecked} class="h-4 w-4 text-indigo-600 border-gray-300 rounded focus:ring-indigo-500"><label for="gw-player-${player.id}" class="ml-3 block text-sm text-gray-700">${player.name}</label>`;
                modalPlayerList.appendChild(checkboxDiv);
            });

            modalPlayerList.querySelectorAll('input[type="checkbox"]').forEach(checkbox => {
                checkbox.addEventListener('change', () => updatePaidForByOthersSection(getPaidForByFromModal()));
            });
            updatePaidForByOthersSection(existingPaidForBy); 
            
            gameWeekModal.style.display = 'block';
        }

        function getPaidForByFromModal() {
            const currentPaidForBy = {};
            paidForByOthersSection.querySelectorAll('.paid-for-by-select').forEach(select => {
                const paidForPlayerId = select.dataset.playerId;
                const payerId = select.value;
                if (payerId && payerId !== paidForPlayerId) {
                    currentPaidForBy[paidForPlayerId] = payerId;
                }
            });
            return currentPaidForBy;
        }

        function updatePaidForByOthersSection(initialPaidForBy = {}) {
            paidForByOthersSection.innerHTML = ''; 

            const selectedPlayerCheckboxes = Array.from(modalPlayerList.querySelectorAll('input:checked'));
            const playersWhoPlayedIds = selectedPlayerCheckboxes.map(cb => cb.value);

            const currentPaidForByForCheckedPlayers = {};
            playersWhoPlayedIds.forEach(playerId => {
                currentPaidForByForCheckedPlayers[playerId] = initialPaidForBy[playerId] || ''; 
            });

            playersWhoPlayedIds.sort((a,b) => players.find(p=>p.id===a)?.name.localeCompare(players.find(p=>p.id===b)?.name)).forEach(playerId => {
                const player = players.find(p => p.id === playerId);
                if (!player) return;

                const div = document.createElement('div');
                div.className = 'flex items-center gap-2';
                div.innerHTML = `
                    <label class="text-sm text-gray-700 w-2/5">${player.name} paid by:</label>
                    <select data-player-id="${player.id}" class="paid-for-by-select mt-1 block w-3/5 p-2 border border-gray-300 rounded-md">
                        <option value="">(Self Pay)</option>
                        ${players.sort((a,b) => a.name.localeCompare(b.name)).map(p => `
                            <option value="${p.id}" ${currentPaidForByForCheckedPlayers[player.id] === p.id ? 'selected' : ''}>${p.name}</option>
                        `).join('')}
                    </select>
                `;
                paidForByOthersSection.appendChild(div);
            });
        }

        modalCloseBtn.addEventListener('click', () => gameWeekModal.style.display = 'none');
        window.addEventListener('click', (event) => {
            if (event.target == gameWeekModal) gameWeekModal.style.display = 'none';
        });

        saveGameWeekBtn.addEventListener('click', async () => {
            if (!isAdminLoggedIn) { console.error("Admin privileges required."); return; }

            const date = document.getElementById('gameweek-date').value;
            const totalCost = document.getElementById('gameweek-cost').value;
            const playerIds = Array.from(modalPlayerList.querySelectorAll('input:checked')).map(cb => cb.value);

            const paidForBy = {};
            paidForByOthersSection.querySelectorAll('.paid-for-by-select').forEach(select => {
                const paidForPlayerId = select.dataset.playerId;
                const payerId = select.value;
                if (payerId && payerId !== paidForPlayerId) { 
                    paidForBy[paidForPlayerId] = payerId;
                }
            });

            if (!date || !totalCost) {
                console.error('Please fill in both the date and total cost.'); 
                return;
            }
            
            const basePath = `artifacts/${appId}/users/${currentUserId}/seasons/${currentSeasonId}`; 
            const gameWeekData = { date, totalCost: parseFloat(totalCost), playerIds, paidForBy };

            if (editingGameWeekId) {
                const gameWeekDocRef = doc(db, `${basePath}/gameWeeks`, editingGameWeekId);
                await updateDoc(gameWeekDocRef, gameWeekData);
            } else {
                await addDoc(collection(db, `${basePath}/gameWeeks`), gameWeekData);
            }

            gameWeekModal.style.display = 'none';
        });

        // --- ADD PAYMENT MODAL LOGIC ---
        function openAddPaymentModal(playerId) {
            if (!isAdminLoggedIn) { console.error("Admin privileges required."); return; }

            selectedPlayerForPayment = playerId;
            const player = players.find(p => p.id === playerId);
            if (player) {
                paymentPlayerNameSpan.textContent = player.name;
                paymentDateInput.value = new Date().toISOString().split('T')[0]; 
                paymentAmountInput.value = '';
                addPaymentModal.style.display = 'block';
            }
        }

        paymentModalCloseBtn.addEventListener('click', () => addPaymentModal.style.display = 'none');
        window.addEventListener('click', (event) => {
            if (event.target == addPaymentModal) addPaymentModal.style.display = 'none';
        });

        savePaymentBtn.addEventListener('click', async () => {
            if (!isAdminLoggedIn) { console.error("Admin privileges required."); return; }

            const paymentDate = paymentDateInput.value;
            const paymentAmount = parseFloat(paymentAmountInput.value);

            if (!paymentDate || isNaN(paymentAmount) || paymentAmount <= 0) {
                console.error('Please enter a valid date and amount for the payment.');
                return;
            }

            const basePath = `artifacts/${appId}/users/${currentUserId}`; 
            await addDoc(collection(db, `${basePath}/payments`), {
                playerId: selectedPlayerForPayment,
                amount: paymentAmount,
                date: paymentDate,
                timestamp: Date.now() 
            });

            addPaymentModal.style.display = 'none';
            selectedPlayerForPayment = null; 
        });
        
        // --- AUTOMATION & SEEDING ---
        async function checkAndCreateAutoGameWeek() {
            if (!isAdminLoggedIn || !currentSeasonId || currentSeasonGameWeeks.length >= 14) return; 

            const today = new Date();
            today.setHours(0, 0, 0, 0); 
            const dayOfWeek = today.getDay(); 
            
            const lastMonday = new Date(today);
            lastMonday.setDate(today.getDate() - (dayOfWeek === 0 ? 6 : dayOfWeek - 1));
            
            const lastMondayStr = lastMonday.toISOString().split('T')[0];

            const gameWeekExists = currentSeasonGameWeeks.some(gw => gw.date === lastMondayStr);

            if (!gameWeekExists) {
                const basePath = `artifacts/${appId}/users/${currentUserId}/seasons/${currentSeasonId}`; 
                await addDoc(collection(db, `${basePath}/gameWeeks`), {
                    date: lastMondayStr, totalCost: 39.00, playerIds: [], paidForBy: {}
                });
            }
        }

        async function seedInitialData() {
            const basePath = `artifacts/${appId}/users/${currentUserId}`; 
            const batch = writeBatch(db);

            const playerNames = [
                "Keiaan McLean", "Joshua Merry", "Alex Merry", "Corey McLean", "Brandon MacDonald", 
                "Danush", "Alfie", "Alex Higgins", "Ben Higgins", "James Bannister", 
                "Keaton McLean", "Charlie", "James Britton", "Jay Jones"
            ];
            playerNames.forEach(name => {
                const playerRef = doc(collection(db, `${basePath}/players`));
                batch.set(playerRef, { name });
            });
            
            const winterStartDate = "2025-01-06";
            const winterDates = [
                "2025-01-06", "2025-01-13", "2025-01-20", "2025-01-27", 
                "2025-02-03", "2025-02-10", "2025-02-17", "2025-02-24", 
                "2025-03-03", "2025-03-10", "2025-03-17", "2025-03-24", 
                "2025-03-31", "2025-04-07"  
            ];
            const winterSeasonRef = doc(collection(db, `${basePath}/seasons`));
            batch.set(winterSeasonRef, { name: "Winter 2025", startDate: winterStartDate });
            winterDates.forEach(date => {
                const gwRef = doc(collection(db, `${basePath}/seasons/${winterSeasonRef.id}/gameWeeks`));
                batch.set(gwRef, { date, totalCost: 39.00, playerIds: [], paidForBy: {} });
            });

            const springStartDate = "2025-04-14"; 
            const springDates = [
                "2025-04-14", "2025-04-21", "2025-04-28", 
                "2025-05-05", "2025-05-12", "2025-05-19", "2025-05-26",
                "2025-06-02", "2025-06-09", "2025-06-16", "2025-06-23",
                "2025-06-30", "2025-07-07", "2025-07-14"
            ];
            const springSeasonRef = doc(collection(db, `${basePath}/seasons`));
            batch.set(springSeasonRef, { name: "Spring 2025", startDate: springStartDate });
            springDates.forEach(date => {
                const gwRef = doc(collection(db, `${basePath}/seasons/${springSeasonRef.id}/gameWeeks`));
                batch.set(gwRef, { date, totalCost: 39.00, playerIds: [], paidForBy: {} });
            });

            const summerStartDate = "2025-07-21";
            const summerSeasonRef = doc(collection(db, `${basePath}/seasons`));
            batch.set(summerSeasonRef, { name: "Summer 2025", startDate: summerStartDate });
            const firstSummerGwRef = doc(collection(db, `${basePath}/seasons/${summerSeasonRef.id}/gameWeeks`));
            batch.set(firstSummerGwRef, { date: summerStartDate, totalCost: 39.00, playerIds: [], paidForBy: {} });

            await batch.commit();
            console.log("Initial data seeded!");
        }

    </script>
</body>
</html>
